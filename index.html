<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lease Statements</title>
  <!-- Tailwind via CDN for quick prototyping. In a production build this should be bundled. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM via CDN for simplicity. For real projects use a bundler (Vite/CRA). -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root" class="container mx-auto p-4"></div>
  <script type="text/javascript">
    const { useState, useEffect } = React;

    // Utility for formatting numbers as ZAR
    const money = (n) => {
      if (isNaN(n)) return 'R0.00';
      return n.toLocaleString('en-ZA', { style: 'currency', currency: 'ZAR' });
    };

    // Helper component for labelled number inputs
    function Field({ label, value, onChange }) {
      return (
        <div className="space-y-1">
          <label className="block text-sm font-medium text-gray-700">{label}</label>
          <input
            type="number"
            value={value}
            onChange={(e) => onChange(parseFloat(e.target.value || '0'))}
            className="w-full rounded-md border-gray-300 p-2 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          />
        </div>
      );
    }

    // Main application component
    function App() {
      const tenantId = 'demoTenant'; // TODO: Replace with actual tenant ID once auth is added

      // Current month string for display
      const [month, setMonth] = useState(new Date().toLocaleString('en-ZA', { month: 'long', year: 'numeric' }));

      // Charge & payment fields
      const [rental, setRental] = useState(8200);
      const [water, setWater] = useState(0);
      const [electricity, setElectricity] = useState(0);
      const [otherDesc, setOtherDesc] = useState('');
      const [otherAmount, setOtherAmount] = useState(0);
      const [paymentAmount, setPaymentAmount] = useState(0);
      const [paymentDate, setPaymentDate] = useState('');
      const [paymentMethod, setPaymentMethod] = useState('EFT');

      // History state
      const [history, setHistory] = useState([]);
      const [loadingHistory, setLoadingHistory] = useState(false);
      const [historyError, setHistoryError] = useState(null);

      // On mount, fetch the tenant's history from the API
      useEffect(() => {
        async function loadHistory() {
          setLoadingHistory(true);
          setHistoryError(null);
          try {
            const res = await fetch(`/api/history?tenantId=${tenantId}`);
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || data.message);
            setHistory(data.history || []);
          } catch (err) {
            console.error(err);
            setHistoryError(err.message);
          } finally {
            setLoadingHistory(false);
          }
        }
        loadHistory();
      }, [tenantId]);

      // Compute total charges for the month
      const charges = rental + water + electricity + (otherAmount || 0);

      // Sum payments from history for current month
      const paymentsThisMonth = history.reduce((sum, row) => sum + (row.payments || 0), 0);

      // Calculate amount due (opening + charges - payments)
      const openingBalance = history.length > 0 ? history[history.length - 1].closingBalance : 0;
      const amountDue = openingBalance + charges - paymentsThisMonth;

      // Handle adding a payment
      async function handleAddPayment() {
          // Basic validation
          if (paymentAmount <= 0) {
            alert('Please enter a valid payment amount.');
            return;
          }
          if (!paymentDate) {
            alert('Please select a payment date.');
            return;
          }
          try {
            const res = await fetch('/api/payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tenantId,
                amount: paymentAmount,
                date: paymentDate,
                method: paymentMethod,
              }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || data.message);
            // Refresh history after successful payment
            setPaymentAmount(0);
            setPaymentDate('');
            // reload history
            const histRes = await fetch(`/api/history?tenantId=${tenantId}`);
            const histData = await histRes.json();
            setHistory(histData.history || []);
          } catch (err) {
            alert(`Error recording payment: ${err.message}`);
          }
      }

      // Handle generating a PDF statement
      async function handleGenerateStatement() {
        try {
          const res = await fetch('/api/statement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tenantId, month }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || data.message);
          window.open(data.url, '_blank');
        } catch (err) {
          alert(`Error generating statement: ${err.message}`);
        }
      }

      return (
        <div className="space-y-6">
          <h1 className="text-2xl font-bold text-indigo-700">Lease Statements</h1>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Charges section */}
            <div className="p-4 bg-white rounded-lg shadow space-y-4">
              <h2 className="font-semibold text-lg">Charges for {month}</h2>
              <Field label="Monthly Rent" value={rental} onChange={setRental} />
              <Field label="Water" value={water} onChange={setWater} />
              <Field label="Electricity" value={electricity} onChange={setElectricity} />
              <div className="space-y-1">
                <label className="block text-sm font-medium text-gray-700">Other Description</label>
                <input
                  type="text"
                  value={otherDesc}
                  onChange={(e) => setOtherDesc(e.target.value)}
                  className="w-full rounded-md border-gray-300 p-2 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                />
              </div>
              <Field label="Other Amount" value={otherAmount} onChange={setOtherAmount} />
            </div>
            {/* Payments section */}
            <div className="p-4 bg-white rounded-lg shadow space-y-4">
              <h2 className="font-semibold text-lg">Record a Payment</h2>
              <Field label="Amount" value={paymentAmount} onChange={setPaymentAmount} />
              <div className="space-y-1">
                <label className="block text-sm font-medium text-gray-700">Date</label>
                <input
                  type="date"
                  value={paymentDate}
                  onChange={(e) => setPaymentDate(e.target.value)}
                  className="w-full rounded-md border-gray-300 p-2 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                />
              </div>
              <div className="space-y-1">
                <label className="block text-sm font-medium text-gray-700">Method</label>
                <select
                  value={paymentMethod}
                  onChange={(e) => setPaymentMethod(e.target.value)}
                  className="w-full rounded-md border-gray-300 p-2 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                >
                  <option value="EFT">EFT</option>
                  <option value="Cash">Cash</option>
                  <option value="Snapscan">Snapscan</option>
                </select>
              </div>
              <button
                onClick={handleAddPayment}
                className="bg-indigo-600 text-white px-3 py-2 rounded-md text-sm font-medium shadow hover:bg-indigo-700"
              >
                Add Payment
              </button>
            </div>
          </div>
          {/* Summary and actions */}
          <div className="p-4 bg-white rounded-lg shadow space-y-2">
            <div className="text-md">Opening Balance: <strong>{money(openingBalance)}</strong></div>
            <div className="text-md">Total Charges: <strong>{money(charges)}</strong></div>
            <div className="text-md">Payments This Month: <strong>{money(paymentsThisMonth)}</strong></div>
            <div className="text-md">Amount Due: <strong>{money(amountDue)}</strong></div>
            <button
              onClick={handleGenerateStatement}
              className="mt-4 bg-green-600 text-white px-3 py-2 rounded-md text-sm font-medium shadow hover:bg-green-700"
            >
              Generate Statement
            </button>
          </div>
          {/* History section */}
          <div className="p-4 bg-white rounded-lg shadow">
            <h2 className="font-semibold text-lg mb-2">History</h2>
            {loadingHistory && <p>Loadingâ€¦</p>}
            {historyError && <p className="text-red-600">Error: {historyError}</p>}
            {!loadingHistory && history.length === 0 && !historyError && <p>No history available.</p>}
            {history.length > 0 && (
              <table className="min-w-full text-left text-sm border">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="px-2 py-1 border">Month</th>
                    <th className="px-2 py-1 border">Opening</th>
                    <th className="px-2 py-1 border">Charges</th>
                    <th className="px-2 py-1 border">Payments</th>
                    <th className="px-2 py-1 border">Closing</th>
                  </tr>
                </thead>
                <tbody>
                  {history.map((row, idx) => (
                    <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-2 py-1 border">{row.month}</td>
                      <td className="px-2 py-1 border">{money(row.openingBalance)}</td>
                      <td className="px-2 py-1 border">{money(row.charges)}</td>
                      <td className="px-2 py-1 border">{money(row.payments)}</td>
                      <td className="px-2 py-1 border">{money(row.closingBalance)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>